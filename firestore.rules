/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict role-based access control model for a food app management portal.
 * There are two primary roles: Admins and Workers. A user's role is determined by the `role`
 * field within their document in the `/workers` collection.
 * - Admins have broad management capabilities over menu items and worker profiles.
 * - Workers have ownership-based access, restricted to managing their own orders.
 *
 * ## Data Structure & Authentication
 * The data is organized to align with this role-based model. Authentication is handled by
 * Firebase Auth, where a user's email is deterministically constructed from their
 * Worker ID (e.g., 'WK001' becomes 'WK001@culinaryflow.app'). This allows rules to securely
 * identify a user's worker document by parsing the ID from their email token.
 * - `/menu_items`: A top-level collection for the restaurant menu. It is publicly readable.
 * - `/workers`: A top-level collection for worker profiles, keyed by the `workerId`.
 * - `/workers/{workerId}/orders`: A subcollection of orders nested under the specific worker
 *   they are assigned to, enforcing a clear ownership hierarchy.
 *
 * ## Key Security Decisions
 * - **Role-Based Access via Email Token**: Authorization is determined by functions that extract
 *   the user's Worker ID from their `request.auth.token.email`. This ID is then used in a `get()`
 *   call to the `/workers/{workerId}` document to check their `role`. This is secure and
 *   centralizes role management within the worker's data.
 * - **Public Menu**: The `/menu_items` collection is publicly readable by anyone, but writable only by Admins.
 * - **Worker Data Privacy**: Workers can only access data within their own document tree
 *   (e.g., `/workers/{their-own-worker-id}/...`). They cannot see other workers' data.
 * - **Admin Oversight**: Admins have read access to all worker data and orders for management
 *   and oversight purposes.
 * - **No User Listing**: Listing all workers is restricted to Admins to protect worker privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for concise and readable rules
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Extracts the Worker ID from the authenticated user's email address.
     * Assumes email format is 'WORKERID@culinaryflow.app'.
     */
    function getWorkerIdFromEmail() {
      return request.auth.token.email.split('@')[0];
    }

    /**
     * Checks if the currently authenticated user is an administrator.
     * Admin status is granted by having `role == 'admin'` in their worker document.
     * This requires one document read.
     */
    function isAdmin() {
      let workerId = getWorkerIdFromEmail();
      return isSignedIn() && get(/databases/$(database)/documents/workers/$(workerId)).data.role == 'admin';
    }

    /**
     * Checks if the document ID from the path matches the Worker ID from the user's token.
     * All IDs are normalized to uppercase for safe comparison.
     */
    function isOwner(workerIdFromPath) {
      return isSignedIn() && getWorkerIdFromEmail() == workerIdFromPath.upper();
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete operations.
     */
    function isExistingOwner(workerIdFromPath) {
      return isOwner(workerIdFromPath) && resource != null;
    }

    /**
     * A generic check to ensure a document exists before an update or delete.
     */
    function documentExists() {
      return resource != null;
    }

    /**
     * @description Publicly readable menu items, manageable only by administrators.
     * @path /menu_items/{menuItemId}
     * @allow (get) Anyone, signed in or not, can read a menu item.
     * @deny (create) A non-admin user attempts to create a new menu item.
     * @principle Public read with role-based writes.
     */
    match /menu_items/{menuItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && documentExists();
      allow delete: if isAdmin() && documentExists();
    }

    /**
     * @description Worker profiles. Managed by Admins, but readable by the worker themselves.
     * @path /workers/{workerId}
     * @allow (get) A worker with ID 'WK001' reads their own profile at /workers/WK001.
     * @deny (list) A regular worker attempts to list all other workers in the system.
     * @deny (create) A user attempts to create their own worker profile.
     * @principle Role-based management with owner-read access.
     */
    match /workers/{workerId} {
      allow get: if isOwner(workerId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && documentExists();
      allow delete: if isAdmin() && documentExists();

      /**
       * @description Orders assigned to a specific worker.
       * @path /workers/{workerId}/orders/{orderId}
       * @allow (create) Worker 'WK001' creates a new order for themselves.
       * @deny (get) Worker 'WK002' tries to read an order belonging to 'WK001'.
       * @principle Enforces document ownership for all operations, with Admin read-only oversight.
       */
      match /orders/{orderId} {
        allow get: if isOwner(workerId) || isAdmin();
        allow list: if isOwner(workerId) || isAdmin();
        allow create: if isOwner(workerId) && request.resource.data.workerId.upper() == workerId.upper();
        allow update: if isExistingOwner(workerId) && request.resource.data.workerId.upper() == resource.data.workerId.upper();
        allow delete: if isExistingOwner(workerId);
      }
    }
  }
}
